{% extends 'base.html' %}
{% load i18n %}
{% load staticfiles %}

{% block page_extra_head %}
    <link href="{% static 'player/videojs/video-js.min.css' %}?ver={{ VERSION }}" rel="stylesheet"/>
    <script src="{% static 'player/videojs/video.min.js' %}?ver={{ VERSION }}"></script>
    {% with 'player/videojs/lang/'|add:request.LANGUAGE_CODE|add:'.js' as videojs_lang %}
        <script src="{% static videojs_lang %}?ver={{ VERSION }}"></script>
    {% endwith %}

    <script src="{% static 'js/videojs-logo-controlbar.js' %}?ver={{ VERSION }}"></script>
    {% if event.broadcaster.enable_viewer_count %}
        <script>let heartbeat_delay = {{ heartbeat_delay }}</script>
        <script src="{% static 'js/viewcounter.js' %}?ver={{ VERSION }}"></script>
    {% endif %}
{% endblock %}


{% block page_content %}
    {% csrf_token %}
    <h3 id="livename" data-liveid="{{ event.broadcaster.id }}"><i data-feather="airplay"></i>&nbsp;{{ event.title|title }}</h3>

    {% if event.is_current %}
        <div id="divvideoonhold" style="display: none;">
            <video id="podvideoonholdplayer"
                   class="video-js vjs-default-skin vjs-big-play-centered"
                   controls height="360" muted autoplay>
            </video>
        </div>
        <div id="divvideoplayer" style="display: block;">
            <div class="row">
                <div class="col">
                    <video id="podvideoplayer"
                           class="video-js vjs-default-skin vjs-big-play-centered"
                           controls height="360" muted autoplay>
                        <source
                                src="{{ event.broadcaster.url }}"
                                type="application/x-mpegURL">
                    </video>

                </div>
            </div>

        </div>


    {% else %}
        <div id="divvideoonhold" style="display: none;">
            <video id="podvideoonholdplayer"></video>
        </div>
        <div id="divvideoplayer" style="display: none;">
            <video id="podvideoplayer"></video>
        </div>
        {% if event.is_past %}
            <div class="p-3 mb-2 bg-warning text-dark">
                {% trans "Event is finished at : " %} {{ event.start_date }} {{ event.end_time }}
                <br>
            </div>
        {% else %}
            <div class="p-3 mb-2 bg-warning text-dark">
                {% trans "The event is scheduled on the : " %} {{ event.start_date }}
                {% trans 'from' %} {{ event.start_time }} {% trans 'to' %} {{ event.end_time }}
            </div>
        {% endif %}
    {% endif %}


{% endblock %}


{% block more_script %}
    <script>
        // Debug if necessary, depends on the settings_local
        var debug = false;
        {% if debug %}
            debug = true;
        {% endif %}

        // Live started
        var started = false;
        // Number of loop until we are sure the live is stopped
        // See video state (cf. https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement/readyState)
        var nbLoop = 0;
        // Live seems stopped
        var stopped = false;

        //videojs.options.flash.swf = "video-js.swf"
        var options = {
            notSupportedMessage: "{% trans 'Please use different browser' %} (Mozzila Firefox, Google Chrome, Safari, Microsoft Edge)",
            language: "fr", //en or nl
            {% if request.GET.is_iframe %}
                fluid: false,
            {% else %}
                fluid: true,
            {% endif %}
            playbackRates: [0.5, 1, 1.5, 2],
            errorDisplay: false,
            loop: false
        }

        // Management of the end of the stream (for Firefox, Chrome... not working for Edge, Safari)
        videojs.Hls.xhr.beforeRequest = function (options) {
            // Reset counter if video state is ok
            if (started && player.readyState() > 2) {
                nbLoop = 0;
            }
            if (started && player.readyState() <= 2) {
                // Check if .m3u8 exists, to be sure that live is stopped
                $.ajax({
                    url: '{{event.broadcaster.url}}',
                    type: 'GET',
                    crossDomain: true,
                    dataType: 'html',
                    success: function (html, status) {
                        stopped = false;
                    },
                    error: function (result, status, error) {
                        stopped = true;
                    },
                    complete: function (result, status) {
                    }
                });
                if (stopped) {
                    nbLoop = nbLoop + 1;
                    // We're waiting a bit to make sure it's not a network / data flow issue...
                    if (debug) {
                        console.info("The streaming live stopped? Video state: " + player.readyState() + ". It's been " + nbLoop + " times that there is no more video stream. After 4 times, we stop.");
                    }
                    if (nbLoop > 3) {
                        // Display of a message of end of live and reload of the page in 9 seconds
                        let modal = player.createModal('{% trans "Thank you for watching this streaming live with us. The page will reload automatically within a few seconds to display the video on hold." %}');
                        setTimeout(function () {
                            location.reload();
                        }, 9000);
                    }
                }
            }
            return options;
        }

        // Management of the video on hold
        {% if event.broadcaster.video_on_hold.is_video %}
            // In this case, loop is necessary
            options["loop"] = true;
            var playerOnHold = videojs('podvideoonholdplayer', options, function () {
            });

            playerOnHold.videoJsLogo({
                imgsrc: '{% static LOGO_PLAYER %}',
                linktitle: '{{TITLE_ETB}} - {{TITLE_SITE}}',
                link: '{{LINK_PLAYER}}'
            });
            var mp4_sources = {{event.broadcaster.video_on_hold.get_video_mp4_json|safe}};
            playerOnHold.src(mp4_sources);
            let modalOnHold = playerOnHold.createModal('{% trans "Live not found, displaying the video on hold, retry every 10 seconds" %}');
            setTimeout(function () {
                modalOnHold.close();
            }, 10000);
        {% endif %}

        // Management of the streaming live
        var player = videojs('podvideoplayer', options, function () {
        })

        {% if event.broadcaster.enable_viewer_count%}
            player.videoJsViewerCount();
        {% endif %}

        player.videoJsLogo({
            imgsrc: '{% static LOGO_PLAYER %}',
            linktitle: '{{TITLE_ETB}} - {{TITLE_SITE}}',
            link: '{{LINK_PLAYER}}'
        });
        player.on('error', function () {
            // Handle successives errors to avoid multiple reload
            if (typeof (errored) == 'undefined' || !errored) {
                var errored = true;
                let modal = player.createModal('{% trans "Live not found, retry in 10 seconds" %}');
                setTimeout(function () {
                    errored = false;
                    modal.close();
                    player.src({
                        src: player.currentSrc(),
                        type: player.currentType(),
                        overrideNative: true
                    });
                }, 10000)
            }
        })

        // Fire this event when live started
        player.on('loadedmetadata', function () {
            if (debug) {
                console.info("Streaming live starts.");
            }
            // Display the streaming live
            started = true;
            if ($("#divvideoonhold")) {
                $("#divvideoonhold").html("");
            }
            if ($("#divvideoplayer")) {
                $("#divvideoplayer").css("display", "block");
            }
        })



        // if event has started or ended while viewing, the page is reloaded
        const reloadIfNeeded = function () {
            const start = new Date("{{ event.get_start.isoformat }}")
            const end = new Date("{{ event.get_end.isoformat }}")

            {% if event.is_coming %}
                setInterval(function () {
                    if (new Date() >= start){
                        location.reload()
                    }
                }, 1000);

            {% elif event.is_current %}
                setInterval(function () {
                    if (new Date() >= end) {
                        location.reload()
                    }
                }, 1000);
            {% endif %}
        }

        // On load
        $(function () {

            reloadIfNeeded()
        })

    </script>


{% endblock more_script %}